<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{% if csrf_token is defined %}{{ csrf_token() }}{% else %}{% endif %}">
    <title>{% block title %}Email Management Tool{% endblock %}</title>

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="{{ url_for('static', filename='favicon.svg') }}">
    <link rel="alternate icon" href="{{ url_for('static', filename='favicon.svg') }}">

    <!-- Fonts: Inter (consistent modern font) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Bootstrap 5.3 CSS -->
    {% if request.path.startswith('/dashboard') %}
      <script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
    {% endif %}
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.min.css">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- Chart.js (deferred - only loaded on dashboard pages) -->
    <!-- <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js" defer></script> -->

    <!-- Modern Token-based CSS System (Oct 31, 2025) -->
    <link rel="stylesheet" href="/static/css/tokens.css">
    <link rel="stylesheet" href="/static/css/base.css">

    <!-- Legacy unified.css (needed for sidebar/nav/layout) -->
    <link rel="stylesheet" href="/static/css/unified.css">

    <!-- Modern components (loads AFTER unified.css to override content styles) -->
    <link rel="stylesheet" href="/static/css/components.css">

    <!-- Page-specific CSS (highest priority) -->
{% block extra_css %}{% endblock %}
</head>
<body class="dark-enabled">
    {% set flashed_messages = get_flashed_messages(with_categories=true) %}
    {% if flashed_messages %}
    <div class="container mt-3">
        {% for category, msg in flashed_messages %}
        <div class="alert alert-{{ category if category else 'info' }} alert-dismissible fade show" role="alert">
            {{ msg }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        {% endfor %}
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            /* jshint ignore:start */
            // @ts-ignore - Jinja2 template syntax
            const flashMessages = {{ flashed_messages | tojson | safe }};
            /* jshint ignore:end */
            flashMessages.forEach(function (entry) {
                const category = (entry[0] || '').toLowerCase();
                const text = entry[1] || '';
                switch (category) {
                    case 'success':
                        if (window.showSuccess) window.showSuccess(text);
                        break;
                    case 'error':
                    case 'danger':
                        if (window.showError) window.showError(text);
                        break;
                    case 'warning':
                        if (window.showWarning) window.showWarning(text);
                        break;
                    default:
                        if (window.showInfo) window.showInfo(text);
                }
            });
        });
    </script>
    {% endif %}
    <div class="dark-app-shell">
        <!-- Modern Sidebar (kept original nav for fallback) -->
        <aside class="sidebar-modern">
            <div class="brand">
                <i class="bi bi-envelope-heart"></i>
                <span>Email Manager</span>
            </div>
            <nav>
                <span class="nav-group-label">Core</span>
                <a class="nav-item-link {% if request.endpoint == 'dashboard.dashboard' %}active{% endif %}" href="/dashboard"><i class="bi bi-speedometer2"></i> Dashboard</a>
                <a class="nav-item-link {% if request.endpoint == 'emails.emails_unified' or request.endpoint == 'emails.email_queue' %}active{% endif %}" href="/emails-unified"><i class="bi bi-inbox-fill"></i> Emails {% if pending_count > 0 %}<span class="badge">{{ pending_count }}</span>{% endif %}</a>
                <a class="nav-item-link {% if request.endpoint == 'compose.compose_email' %}active{% endif %}" href="/compose"><i class="bi bi-pencil-square"></i> Compose</a>
                <span class="nav-group-label">Management</span>
                <a class="nav-item-link {% if request.endpoint == 'watchers.watchers_page' %}active{% endif %}" href="/watchers"><i class="bi bi-activity"></i> Watchers</a>
                <a class="nav-item-link {% if request.endpoint == 'moderation.rules' %}active{% endif %}" href="/rules"><i class="bi bi-shield-check"></i> Rules</a>
                <a class="nav-item-link {% if request.endpoint == 'accounts.email_accounts' or request.endpoint == 'accounts.add_email_account' %}active{% endif %}" href="/accounts"><i class="bi bi-envelope-at"></i> Accounts</a>
                <a class="nav-item-link {% if request.endpoint == 'accounts.accounts_import_page' %}active{% endif %}" href="/accounts/import"><i class="bi bi-upload"></i> Import Accounts</a>
                <a class="nav-item-link {% if request.endpoint == 'diagnostics' %}active{% endif %}" href="/diagnostics"><i class="bi bi-heart-pulse"></i> Diagnostics</a>
                <a class="nav-item-link {% if request.endpoint == 'watchers.settings_page' %}active{% endif %}" href="/settings"><i class="bi bi-sliders"></i> Settings</a>
<a class="nav-item-link {% if request.endpoint == 'styleguide.styleguide' %}active{% endif %}" href="/styleguide"><i class="bi bi-palette2"></i> Style Guide</a>
<a class="nav-item-link {% if request.endpoint == 'diagnostics.interception_test_dashboard' %}active{% endif %}" href="/interception-test"><i class="bi bi-flask"></i> Interception Test</a>
            </nav>
            <div class="sidebar-footer">
                <div class="footer-meta">
                    <span class="footer-label">Signed in</span>
                    <span class="footer-value">{% if current_user.is_authenticated %}{{ current_user.username }}{% else %}Guest{% endif %}</span>
                </div>
                <div class="footer-actions">
                    <a href="/settings" class="btn btn-ghost btn-sm">
                        <i class="bi bi-sliders"></i> Settings
                    </a>
                    {% if current_user.is_authenticated %}
                    <a href="/logout" class="btn btn-ghost btn-sm">
                        <i class="bi bi-box-arrow-right"></i> Logout
                    </a>
                    {% else %}
                    <a href="/login" class="btn btn-secondary btn-sm">
                        <i class="bi bi-box-arrow-in-right"></i> Login
                    </a>
                    {% endif %}
                </div>
            </div>
        </aside>
        <div class="main-modern">
            <header class="command-bar">
                <button class="toggle-nav" type="button" aria-label="Toggle navigation" onclick="document.querySelector('.sidebar-modern').classList.toggle('open')">
                    <i class="bi bi-list"></i>
                </button>

                <!-- status pills (SMTP, Watchers, Pending) -->
                <div class="header-status toolbar">
                    {% if not imap_only %}
                    <span id="nav-smtp" class="health-pill" title="SMTP Proxy health">
                        <i class="bi bi-diagram-2"></i>
                        <span class="pill-text">SMTP: --</span>
                    </span>
                    {% endif %}
                    <span id="nav-watchers" class="health-pill" title="Active IMAP watchers">
                        <i class="bi bi-activity"></i>
                        <span class="pill-text">Watchers: --</span>
                    </span>
                    <span class="health-pill" title="Pending moderation items">
                        <i class="bi bi-flag"></i>
                        <span class="pill-text">Pending: {{ pending_count }}</span>
                    </span>
                </div>
            </header>
            <div class="content-scroll">
                {% block content %}{% endblock %}
            </div>
        </div>
    </div>


    <!-- CSS Toggle Button (DEV ONLY - Remove in production) -->
    <button id="css-toggle-btn" style="position: fixed; bottom: 20px; right: 20px; z-index: 99999; padding: 10px 15px; background: #ef4444; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; box-shadow: 0 4px 12px rgba(0,0,0,0.3); font-size: 13px;">
        Swap Unified CSS
    </button>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Global flags as a real JSON literal (no stringify/parse, no escapejs) -->
    <script>
        // @ts-ignore - Jinja2 template syntax
        window.ATTACHMENTS_FLAGS = {{ (attachments_flags | default({'ui': false, 'edit': false}, true)) | tojson | safe }};
    </script>

    <!-- Safe no-op stubs for dashboard functions (prevents errors on non-dashboard pages) -->
    <script>
        window.performEmailSearch    = window.performEmailSearch    || function(){ return false; };
        window.clearEmailSearch      = window.clearEmailSearch      || function(){ return false; };
        window.switchDashboardFilter = window.switchDashboardFilter || function(){};
        window.loadDashboardEmails   = window.loadDashboardEmails   || function(){};
    </script>

    <script src="/static/js/app.js"></script>

    {% block extra_js %}{% endblock %}
    <script>
    function renderHealthWidgets(payload) {
        if (!payload || typeof payload !== 'object') {
            return;
        }
        const setText = (id, value, fallback = '—') => {
            const node = document.getElementById(id);
            if (!node) return;
            const shouldUseFallback = value === undefined || value === null || value === '';
            node.textContent = shouldUseFallback ? fallback : value;
        };

        const dbState = (payload.db || '').toString().toLowerCase() === 'ok' ? 'OK' : (payload.db ? String(payload.db).toUpperCase() : 'ERROR');
        setText('dbStatus', dbState, 'UNKNOWN');

        const smtpListening = payload.smtp && typeof payload.smtp.listening === 'boolean'
            ? (payload.smtp.listening ? 'Listening' : 'Down')
            : null;
        setText('smtpListening', smtpListening, 'Unknown');

        const heldCount = payload.held_count ?? payload.held ?? payload.pending ?? 0;
        setText('heldCount', heldCount, 0);

        const releasedCount = payload.released_24h ?? payload.released ?? 0;
        setText('released24h', releasedCount, 0);

        const latency = payload.median_latency_ms;
        if (document.getElementById('medianLatency')) {
            const latencyLabel = Number.isFinite(Number(latency)) ? `${Math.round(Number(latency))} ms` : '–';
            setText('medianLatency', latencyLabel, '–');
        }

        const secretConfigured = payload.security && payload.security.secret_key_configured;
        if (document.getElementById('secretKey')) {
            setText('secretKey', secretConfigured ? 'Configured' : 'Missing', 'Missing');
        }
    }

    // Topbar health badges
    async function refreshTopbarHealth(){
        try{
            const r = await fetch('/healthz');
            if(!r.ok) return;
            const j = await r.json();
            renderHealthWidgets(j);
            const smtp = document.getElementById('nav-smtp');
            if(smtp){
              const ok = j.smtp && j.smtp.listening;
              const label = smtp.querySelector('.pill-text');
              if(label){
                label.textContent = ok ? 'SMTP: OK' : 'SMTP: DOWN';
              }
              smtp.classList.remove('ok','down');
              smtp.classList.add(ok ? 'ok' : 'down');
            }

            const w = document.getElementById('nav-watchers');
            // Enhanced status breakdown
            let statusCounts = {};
            if (Array.isArray(j.workers)) {
                j.workers.forEach(worker => {
                    const status = (worker.status || 'unknown').toLowerCase();
                    statusCounts[status] = (statusCounts[status] || 0) + 1;
                });
            }
            const polling = statusCounts['polling'] || 0;
            const idle = statusCounts['idle'] || 0;
            const active = statusCounts['active'] || 0;
            const total = polling + idle + active;

            // Build display text with status breakdown
            if (total === 0) {
                const label = w.querySelector('.pill-text');
                if(label){
                  label.textContent = 'Watchers: 0';
                }
                w.classList.remove('ok','down');
                w.classList.add('down');
                w.removeAttribute('title');
            } else {
                let parts = [];
                if (polling > 0) parts.push(`P:${polling}`);
                if (idle > 0) parts.push(`I:${idle}`);
                if (active > 0) parts.push(`A:${active}`);
                const label = w.querySelector('.pill-text');
                if(label){
                  label.textContent = `Watchers: ${total} (${parts.join(', ')})`;
                }
                w.classList.remove('ok','down');
                w.classList.add('ok');
                w.title = `Active watchers - P=Polling, I=IDLE, A=Active`;
            }
        }catch(e){/* ignore */}
    }
    refreshTopbarHealth(); setInterval(refreshTopbarHealth, 10000);

    // ============================================================================
    // Safe Data Access Helpers - Prevent crashes from missing/malformed data
    // Idempotent guards prevent "already declared" errors
    // ============================================================================
    (function () {
        // Only define helpers if they don't exist yet
        if (!window.escapeHtml) {
            /**
             * Simple HTML escape to prevent XSS
             */
            window.escapeHtml = function(str) {
                if (str == null) return '';
                return String(str)
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#039;');
            };
        }

        if (!window.safeGet) {
            /**
             * Safely get nested property with default value
             * Example: safeGet(obj, 'user.name', 'Unknown')
             */
            window.safeGet = function(obj, path, fallback) {
                try {
                    return path.split('.').reduce((o, k) => (o == null ? undefined : o[k]), obj) ?? fallback;
                } catch (_) { return fallback; }
            };
        }

        if (!window.safeRenderRow) {
            /**
             * Safely render a table row from data object with field defaults
             * Example: safeRenderRow(account, { name: 'Unknown', email: 'N/A' })
             */
            window.safeRenderRow = function(row, defaults) {
                const out = { ...defaults };
                try {
                    for (const k in row) if (Object.prototype.hasOwnProperty.call(row, k)) out[k] = row[k] ?? out[k];
                } catch (_) { /* swallow */ }
                return out;
            };
        }

        if (!window.showPanelError) {
            /**
             * Display error in a container element instead of crashing
             */
            window.showPanelError = function(panelId, message) {
                const host = document.getElementById(panelId) || document.getElementById('email-search-results');
                if (!host) return;
                host.style.display = 'block';
                host.innerHTML = '<div class="alert alert-danger">' + window.escapeHtml(message || 'Error') + '</div>';
            };
        }
    })();
    </script>

    <!-- CSS Toggle Script (DEV ONLY) -->
    <script>
    (function() {
        const btn = document.getElementById('css-toggle-btn');
        const unifiedCSS = document.querySelector('link[href*="unified.css"]:not([href*="unified-orig"])');
        const unifiedOrigCSS = document.querySelector('link[href*="unified-orig.css"]');

        if (!btn) return;

        // State: true = unified.css, false = unified-orig.css
        let useOriginal = false;

        btn.addEventListener('click', function() {
            useOriginal = !useOriginal;

            if (useOriginal) {
                // Switch to unified-orig.css
                if (unifiedCSS) unifiedCSS.disabled = true;
                if (unifiedOrigCSS) unifiedOrigCSS.disabled = false;

                btn.style.background = '#3b82f6'; // Blue
                btn.textContent = 'Using: unified-orig.css';

                if (window.showInfo) {
                    window.showInfo('Switched to unified-orig.css');
                }
            } else {
                // Switch to unified.css
                if (unifiedCSS) unifiedCSS.disabled = false;
                if (unifiedOrigCSS) unifiedOrigCSS.disabled = true;

                btn.style.background = '#ef4444'; // Red
                btn.textContent = 'Using: unified.css';

                if (window.showInfo) {
                    window.showInfo('Switched to unified.css');
                }
            }
        });

        // Set initial state based on what's enabled
        if (unifiedCSS && !unifiedCSS.disabled) {
            useOriginal = false;
            if (unifiedOrigCSS) unifiedOrigCSS.disabled = true;
            btn.style.background = '#ef4444';
            btn.textContent = 'Using: unified.css';
        } else if (unifiedOrigCSS && !unifiedOrigCSS.disabled) {
            useOriginal = true;
            if (unifiedCSS) unifiedCSS.disabled = true;
            btn.style.background = '#3b82f6';
            btn.textContent = 'Using: unified-orig.css';
        } else {
            btn.textContent = 'No unified CSS found';
            btn.style.background = '#6b7280';
        }

        btn.title = 'Click to switch between unified.css and unified-orig.css';
    })();
    </script>
</body>
</html>
