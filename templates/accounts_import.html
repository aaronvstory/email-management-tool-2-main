{% extends 'base.html' %}

{% block extra_css %}
<!-- Accounts Import styles now in unified.css (extracted Oct 25, 2025) -->
{% endblock %}

{% block content %}
<div class="page-header mb-4">
  <div>
    <h2><i class="bi bi-cloud-upload"></i> Import Accounts</h2>
    <p class="text-muted mb-0">Bulk import email accounts from a CSV file.</p>
  </div>
  <div class="page-tools">
    <button class="btn btn-secondary btn-sm" type="button" id="downloadTemplate">
      <i class="bi bi-download"></i> Download Template
    </button>
    <a class="btn btn-ghost btn-sm" href="{{ url_for('accounts.email_accounts') }}">
      <i class="bi bi-arrow-left"></i> Back to Accounts
    </a>
  </div>
</div>

<div class="panel">
  <div class="panel-header">
    <div class="panel-title">CSV Import</div>
  </div>
  <div class="panel-body">
    <div class="info-box">
      <p>
        <strong>Upload a CSV to add or update accounts.</strong><br>
        <br>
        <strong>Required columns:</strong><br>
        <code>email_address</code>, <code>imap_password</code>, <code>smtp_password</code><br>
        <br>
        <strong>Optional columns:</strong><br>
        <code>account_name</code>, <code>imap_host</code>, <code>imap_port</code>, <code>imap_use_ssl</code>,<br>
        <code>smtp_host</code>, <code>smtp_port</code>, <code>smtp_use_ssl</code>, <code>imap_username</code>,<br>
        <code>smtp_username</code>, <code>is_active</code>
      </p>
    </div>

    <form id="importForm" action="{{ url_for('accounts.api_import_accounts') }}" method="post" enctype="multipart/form-data" class="mt-2">
      <div class="mb-3">
        <label class="form-label">CSV File</label>
        <input class="form-control" type="file" name="file" accept=".csv" required />
      </div>

      <div class="form-check mb-3">
        <input class="form-check-input" type="checkbox" name="auto_detect" id="auto_detect" checked>
        <label class="form-check-label" for="auto_detect">
          Auto-detect server settings when missing
        </label>
      </div>

      <div class="d-flex gap-2">
        <button class="btn btn-secondary" type="submit">
          <i class="bi bi-upload"></i> Import Accounts
        </button>
      </div>
    </form>

    <div id="resultPanel" class="mt-3" style="display:none;">
      <div class="alert alert-info" id="resultText"></div>
    </div>
  </div>
</div>

<script>
  // Download sample CSV template (client-side generated)
  document.getElementById('downloadTemplate')?.addEventListener('click', function () {
    const csv = 'email_address,imap_password,smtp_password,account_name,imap_host,imap_port,imap_use_ssl,smtp_host,smtp_port,smtp_use_ssl,imap_username,smtp_username,is_active\nuser@example.com,app-password-here,app-password-here,Example Account,,,1,,,1,,,1\n';
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'accounts_template.csv';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    if (window.showSuccess) {
      showSuccess('Template downloaded successfully');
    }
  });

  // AJAX import with toasts
  const form = document.getElementById('importForm');
  form?.addEventListener('submit', async function (e) {
    e.preventDefault();
    const fd = new FormData(form);

    // Show loading toast
    if (window.showInfo) {
      showInfo('Importing accounts...');
    }

    try {
      const resp = await fetch(form.action, { method: 'POST', body: fd });
      const data = await resp.json();

      if (!resp.ok || data.success === false) {
        const msg = (data && (data.error || data.message)) || ('Import failed (' + resp.status + ')');
        if (window.showError) showError(msg);
        document.getElementById('resultText').textContent = msg;
        document.getElementById('resultPanel').style.display = '';
        return;
      }

      const summary = `Inserted: ${data.inserted || 0} • Updated: ${data.updated || 0} • Errors: ${data.errors || 0}`;
      if (window.showSuccess) showSuccess('Import complete — ' + summary);
      document.getElementById('resultText').textContent = summary;
      document.getElementById('resultPanel').style.display = '';

      // Reset form on success
      if (data.inserted > 0 || data.updated > 0) {
        form.reset();
      }
    } catch (err) {
      const msg = 'Import error: ' + (err && err.message ? err.message : String(err));
      if (window.showError) showError(msg);
      document.getElementById('resultText').textContent = msg;
      document.getElementById('resultPanel').style.display = '';
    }
  });
</script>
{% endblock %}
